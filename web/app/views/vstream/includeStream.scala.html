@(stream: Stream, displayHeader: Boolean =true, displayOverview: Boolean =true, displayPlot: Boolean =true, displayToolbar: Boolean =true)

@WIN_5M() = {5*60*1000}
@WIN_30M() = {30*60*1000}
@WIN_1H() = {60*60*1000}
@WIN_1D() = {24*60*60*1000}
@WIN_1W() = {7*24*60*60*1000}
@WIN_1M() = {30*24*60*60*1000}
@WIN_1Y() = {365*24*60*60*1000}



@if(stream != null) {
<div id="streamblock@{stream.id}">
@if(stream.hasData() && stream.canRead(Secured.getCurrentUser())) {
<div class="stream_header_block @if(!displayHeader){hidden}">
	<div id="streamtitle@{stream.id}" class="streamtitle">
		<br />
		@if(stream.file.getPath()!="" && stream.file.getPath()!=null ) {
			Stream
		} else { 
			Unnamed Stream
		}
		<a href="@routes.Application.viewStream(stream.id)" data-toggle="tooltip" title="id : @{stream.id}">@if(stream.file != null) {@stream.file.getPath()} else {id: @{stream.id}}</a>
		@if(stream.resource != null && stream.canWrite(Secured.getCurrentUser())) {
			(from resource <a href="@routes.CtrlResource.getById(stream.resource.id)">@{stream.resource.label}</a>)
		}
		@if(stream.owner.userName!=Secured.getCurrentUser().userName) {
		(owner: <a href="/accounts/@stream.owner.userName">@stream.owner.userName</a>)
		}
		@if(displayToolbar){
		<span class="pull-right">@vstream.streamToolbar(stream, stream.canWrite(Secured.getCurrentUser()), false, stream.publicAccess || stream.publicSearch)</span>
		}
		</div>
		<div class="row-fluid controls controls-row">
		@**Show key?**@
		@if(stream.showKey(Secured.getCurrentUser())!=null) {
			<!--@if(stream.owner.id==Secured.getCurrentUser().id) {
			<button class="span2 btn btn-danger btn-small streamRegenerateKey" id="streamRegenerateKey@{stream.id}" data-streamId="@{stream.id}" data-toggle="tooltip" title="Click to generate a new key if compromised"><i class="icon-refresh icon-white"></i> Regenerate key</button>
			}	
			<input class="span8" type="text" id="streamKey@{stream.id}" name="keyUrl" value="@sicsthSenseURL()@{routes.CtrlStream.postByKey(stream.showKey(Secured.getCurrentUser()))}" readonly="readonly">
			-->
			<label class="span1">API URL:</label>
			<input class="span11" type="text" id="streamKey@{stream.id}" name="keyUrl" value="@sicsthSenseURL():8080@stream.getHierarchy()" readonly="readonly">
		}	
</div>
	</div>	
@if(displayOverview || displayPlot){

<div id="chart-@{stream.id}" style="height: 270px; min-width: 500px"></div>
<script>
	var host = document.location.hostname;
	chartLastGet["@{stream.id}"] = 1;
	var options = {
		xAxis: { type:'datetime' },
		scrollbar : { enabled : false },
		series: [{
			name: "Stream "+@{stream.id},
			data: [],
			type : 'area',
			fillColor : { linearGradient : { x1: 0, y1: 0, x2: 0, y2: 1 },
				stops : [[0, 'rgba(76,120,230,0.3)'], [1, 'rgba(10,10,20,0.05)']] }
		}],
		chart: { 
			renderTo: 'container',
				events: {
				load : function() {
					/*
					// set up the updating of the chart each second
					var series = this.series[0];
					setInterval(function() {
						var url = "http://"+host+":8080/users/1/resources/1/streams/@{stream.id}/data?since="+chartLastGet["@{stream.id}"];
						$.getJSON(url, function(update) {
							if (update) {
								console.log("Get: "+url);
								$.each(update, function (i, item) {
									console.log("add new data point: "+item.timestamp+" to Stream "+@{stream.id});
									series.addPoint([item.timestamp, item.value]);
									if (item.timestamp>chartLastGet["@{stream.id}"]) {chartLastGet["@{stream.id}"]=item.timestamp;}
								});
							}
						}) } , 10000);
			*/
				}
			}
		},
		rangeSelector: {
			buttons: [{
				count: 5,
				type: 'minute',
				text: '5M'
			}, {
				count: 1,
				type: 'hour',
				text: '1H'
			}, {
				type: 'all',
				text: 'All'
			}],
			inputEnabled: false,
			selected: 3
		}
	};

chartOptions["@{stream.id}"]=options;
//console.log("first series");
//console.log(chartOptions["@{stream.id}"].series);

// Perform initial loading of the chart, note the time of GET
$.ajax({
  dataType: "json",
  url: "http://"+host+":8080/users/1/resources/1/streams/@{stream.id}/data?limit=500",
	timeout: 3000,
  success: function(data, textStatus, jqXHR) {
		//console.log("Ajax:"+textStatus);
		if (data) {
			//console.log("got json!" +data);
			$.each(data, function (i, item) {
				console.log("add initial data point: "+item.timestamp);
				chartOptions["@{stream.id}"].series[0].data.push([item.timestamp,item.value]); 
				if (item.timestamp>chartLastGet["@{stream.id}"]) {chartLastGet["@{stream.id}"]=item.timestamp;}
			});
			
			//console.log(options);
			$('#chart-@{stream.id}').highcharts('StockChart', chartOptions["@{stream.id}"]);
		}
	},
	error: function() {
		console.log("Got an AJAX JSON GET error");
		$('#chart-@{stream.id}').hide();
	}
});


</script>

	}
	} else {
	@if(displayHeader){
		<div id="streamtitle@{stream.id}" class="streamtitle">
			Stream 
			@if( stream.canRead(Secured.getCurrentUser()) ) {
			<a href="@routes.Application.viewStream(stream.id)">@if(stream.file != null) {@stream.file.getPath()} else {id: @{stream.id}}</a>
			} else {
			<span>@if(stream.file != null) {@stream.file.getPath()} else {id: @{stream.id}}</span>
			}
@*		@if(stream.owner.userName!=Secured.getCurrentUser().userName) {
			owner: <a href="/accounts/@stream.owner.userName">@stream.owner.userName</a>
		} *@
			@if(displayToolbar){
				<span class="pull-right">@vstream.streamToolbar(stream, stream.canWrite(Secured.getCurrentUser()), false, stream.publicAccess || stream.publicSearch)</span>
			}
		</div>
		@**Show key?**@
		@if(stream.showKey(Secured.getCurrentUser())!=null) {
			<div class="row-fluid controls controls-row">
			<!--
			@if(stream.owner.id==Secured.getCurrentUser().id) {
			<button class="span2 btn btn-danger btn-small streamRegenerateKey" id="streamRegenerateKey@{stream.id}" data-streamId="@{stream.id}"><i class="icon-refresh icon-white"></i> Regenerate key</button>
			}	
			<input class="span10" type="text" id="streamKey@{stream.id}" name="keyUrl" value="@sicsthSenseURL()@{routes.CtrlStream.postByKey(stream.showKey(Secured.getCurrentUser()))}" readonly="readonly">
			-->
			<label class="span1">API URL:</label>
			<input class="span11" type="text" id="streamKey@{stream.id}" name="keyUrl" value="@sicsthSenseURL():8080@stream.getHierarchy()" readonly="readonly">
		</div>
		}	
		<div class="streamNoDataLine">
		 <span style="color: #888; padding-left: 10px;">No data currently available.</span>
		</div>
	}
	}
	</div>
}
